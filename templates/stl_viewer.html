<!DOCTYPE html>
<html lang="en">

<head>
    <title>STL Viewer</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.110/examples/js/controls/OrbitControls.js"></script>
    <script src="https://s3-us-west-2.amazonaws.com/s.cdpn.io/1534167/STLLoader.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        canvas {
            width: 500px !important;
            height: 300px !important;
        }
    </style>
</head>

<body>
    <div id="stlContainer"></div>
    <script>
        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer();
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        const stlContainer = document.getElementById('stlContainer');

        fetch('/get_uploaded_stl_files')
            .then(response => response.json())
            .then(data => {
                data.forEach(filename => {
                    const stlDiv = document.createElement('div');
                    stlDiv.innerHTML = `<h3>${filename}</h3>`;
                    stlContainer.appendChild(stlDiv);

                    const loader = new THREE.STLLoader();
                    loader.load(`/uploads/${filename}`, function (geometry) {
                        scene.children.forEach(child => {
                            if (child instanceof THREE.Mesh) {
                                scene.remove(child);
                            }
                        });

                        const material = new THREE.MeshPhongMaterial({ color: 0xCCCCCC, specular: 0x111111, shininess: 200 });
                        const mesh = new THREE.Mesh(geometry, material);
                        scene.add(mesh);

                        const dimensions = calculateDimensions(geometry);
                        stlDiv.innerHTML += `<p>Width: ${dimensions.width.toFixed(2)} | Height: ${dimensions.height.toFixed(2)} | Depth: ${dimensions.depth.toFixed(2)}</p>`;
                    });
                });
            })
            .catch(error => console.error('Error fetching uploaded STL files:', error));

        function calculateDimensions(geometry) {
            const box = new THREE.Box3().setFromObject(new THREE.Mesh(geometry));
            const size = new THREE.Vector3();
            box.getSize(size);
            return { width: size.x, height: size.y, depth: size.z };
        }

        const light = new THREE.AmbientLight(0xffffff, 0.5);
        scene.add(light);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
        directionalLight.position.set(5, 5, 5);
        scene.add(directionalLight);

        camera.position.z = 20;

        function animate() {
            requestAnimationFrame(animate);
            controls.update(); 
            renderer.render(scene, camera);
        }
        animate();
    </script>

</body>

</html>